services:
  openldap:
    image: osixia/openldap:latest
    environment:
      LDAP_BASE_DN: ${LDAP_BASE_DN}
      LDAP_ORGANISATION: ${LDAP_ORGANISATION}
      LDAP_DOMAIN: ${LDAP_DOMAIN}
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
#      LDAP_TLS: "false"             # deactivate TLS for the LDAP server
    volumes:
      - ./ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/50-bootstrap.ldif
      - ./ldap/ldap-database:/var/lib/ldap
      - ./ldap/ldap-config:/etc/ldap/slapd.d 
    ports:
      - "389:389"                   # default port for unsecured LDAP
      - "636:636"                   # default port for secured LDAP
    command: --copy-service
    restart: unless-stopped
        
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: openldap
#      PHPLDAPADMIN_HTTPS: "false"   # deactivate HTTPS
    ports:
 #     - "8081:80"
      - "10443:443"
    restart: unless-stopped
    depends_on:
      - openldap

  postgres:
    image: postgres
    restart: always
    security_opt:
      - no-new-privileges:true
    pids_limit: 100
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/postgresql
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    # chown -R postgres:postgres ./postgres
    # chmod -R 777 ./postgres
      - ./postgres/pg-init-scripts:/docker-entrypoint-initdb.d
    environment:
     # - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${POSTGRES_USER_NAME}
      - POSTGRES_PASSWORD=${POSTGRES_USER_PASSWORD}
      - POSTGRES_MULTIPLE_DATABASES=nextcloud,mattermost
      - TZ='Europe/Paris'

  redis:
    image: redis:alpine
    restart: always

  code:
    image: collabora/code:latest
    restart: always
    environment:
      - password=${COLLABORA_PASSWORD}
      - username=${COLLABORA_USERNAME}
#      - aliasgroup1=https://collabora.mydomain.com:443
#      - aliasgroup2=https://nextcloud.myseconddomain.com:443
      - server_name=${SERVER_NAME}
      - extra_params=--o:ssl.enable=true
    ports:
      - 9980:9980
 
  nextcloud:
    image: nextcloud
    restart: always
    ports:
      - 8080:80
    volumes:
      - ./nextcloud/html:/var/www/html
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${POSTGRES_USER_NAME}
      - POSTGRES_PASSWORD=${POSTGRES_USER_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${SERVER_NAME}
    depends_on:
      - redis
      - postgres

  mattermost:
    image: mattermost/mattermost-enterprise-edition:9.11.2
    restart: always
    security_opt:
      - no-new-privileges:true
    pids_limit: 200
    read_only: false
    tmpfs:
      - /tmp
    volumes:
      - ./mattermost/config:/mattermost/config:rw
      - ./mattermost/data:/mattermost/data:rw
      - ./mattermost/logs:/mattermost/logs:rw
      - ./mattermost/plugins:/mattermost/plugins:rw
      - ./mattermost/client/plugins:/mattermost/client/plugins:rw
      - ./mattermost/bleve-indexes:/mattermost/bleve-indexes:rw
    environment:
      # timezone inside container
      - TZ='Europe/Paris'

      # necessary Mattermost options/variables (see env.example)
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://${POSTGRES_USER_NAME}:${POSTGRES_USER_PASSWORD}@postgres:5432/mattermost?sslmode=disable&connect_timeout=10

      # necessary for bleve
      - MM_BLEVESETTINGS_INDEXDIR=/mattermost/bleve-indexes

      # additional settings
      - MM_SERVICESETTINGS_SITEURL=http://${SERVER_NAME}:8065/
    ports:
      - 8065:8065
      - 8443:8443/udp
      - 8443:8443/tcp
    depends_on:
      - postgres